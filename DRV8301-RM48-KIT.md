
# Описание связи контактов МК и целевых функций для DRV8301-RM48-KIT

## Перечень целевых функций
* U, Системное напряжение питания
* M1, Обмотка мотора №1
* M2, Обмотка мотора №2
* M3, Обмотка мотора №3
* I1, Ток через токоизмерительный резистор в обмотке мотора №1
* I2, Ток через токоизмерительный резистор в обмотке мотора №2
* I3, Ток через токоизмерительный резистор в обмотке мотора №3
* EN_GATE, включение DRV8301
* /SCS, chip select для SPI DRV8301
* SDI для SPI DRV8301
* SDO для SPI DRV8301
* SCLK для SPI DRV8301
* H1, сигнал с датчика Холла №1
* H2, сигнал с датчика Холла №2
* H3, сигнал с датчика Холла №3

## Системная информация
Опорное напряжение на АЦП равно 3.3 Вольта.

Микроконтроллер типа xRM48L952ZWT. Кварцевый резонатор 16 МГц.

Для отладки можно использовать UART, который выведен через опторазвязку на отладочный разъём USB; опторазвязка сможет пропустить частоту не более 100 МГц. Интерфейс LIN; контактные площадки A7 (LINTX), B7 (LINRX).

Для отладки можно использовать светодиод D15, управляемый высоким уровнем HET1\_01.

Для использования внешнего отладчика его необходимо подключить к J104 и установить перемычку J111. Сигналы с отладчика подаются через гальваническую изоляцию; пропускается частота не более 2 МГц.

Для использования встроенного отладчика типа XDS100v2 необходимо удалить перемычку J111. Предельная тактовая ограничена работой PLD и составляет 3 МГц; гальваноразвязка способна пропускать более высокие частоты (до 100 МГц).

Имеется возможность подключения к шине Ethernet через U12 -- DP83640, которая подключается к чистому RMII интерфейсу с внешним кварцевым резонатором 50 МГц.

### EN_GATE
Контакт 42 разъёма, GIOA4, площадка A6

### DC_CAL
Контакт 81 разъёма, GIOB4, площадка G1 


### Формирование ШИМ для DRV8301
Так как производится работа в 3-канальном ШИМ, то используется только сигналы управления верхними ключами; сигналы управления нижними ключами игнорируются драйвером DRV8301.

По-умолчанию DRV8301 включается в режиме 6-канального ШИМ; необходимо перепрограммировать его на работу в 3-канальном режиме используя SPI.

#### M1
Цепь PWM\_AH, контакт 23 разъёма. HET1\_00, площадка K18

Цепь PWM\_AL (не используется в FOC), контакт 73 разъёма. HET1\_02, площадка W5.

#### M2
Цепь PWM\_BH, контакт 24 разъёма. HET1\_04, площадка U12

Цепь PWM\_BL (не используется в FOC), контакт 74 разъёма. HET1\_06, площадка W3.

#### M3
Цепь PWM\_CH, контакт 25 разъёма.
Далее цепь переходит в GPIO\_04, которая может быть подключена к HET1\_08 (если GIOB0=0) или к GIOA2/HET2\_00 (если GIOB0=1).

Цепь PWM\_CL (не используется в FOC), контакт 75 разъёма.
Далее цепь переходит в GPIO\_05, которая может быть подключена к HET1\_10 (если GIOB0=0) или к GIOA6/HET2\_04 (если GIOB0=1).

### Измерение тока в обмотках
Будет использованы каналы с внешних усилителей (так как три канала), в противовес измерения тока только по двум каналам используя встроенные в DRV8301 усилители.

#### EXT\_IA-FB, выход TLV2781DBVR
Коэффициент усиления =20.
Токоизмерительный резистор имеет номинал 0.002 Ом.
Итоговый коэффициент преобразования тока: 0.04 Вольта/Ампер.

Контакт 69 разъёма, через 33 Ома на каналы АЦП AD1IN14/AD2IN14, площадка R18

#### EXT\_IB-FB, выход TLV2781DBVR
Коэффициент усиления =20.
Токоизмерительный резистор имеет номинал 0.002 Ом.
Итоговый коэффициент преобразования тока: 0.04 Вольта/Ампер.

Контакт 19 разъёма, через 33 Ома на каналы АЦП AD1IN22/AD2IN6, площадка R19

#### EXT\_IC-FB, выход TLV2781DBVR
Коэффициент усиления =20.
Токоизмерительный резистор имеет номинал 0.002 Ом.
Итоговый коэффициент преобразования тока: 0.04 Вольта/Ампер.

Контакт 57 разъёма, через 33 Ома на каналы АЦП AD1IN8/AD2IN8, площадка P18

#### IA-FB, выход DRV8301
Коэффициент усиления программируется в DRV8301 (10, 20, 40 или 80 V/V).
Токоизмерительный резистор имеет номинал 0.002 Ом.
Итоговый коэффициент преобразования тока: 0.02, 0.04, 0.08 или 0.16 Вольт/Ампер.

Контакт 13 разъёма, через 33 Ома на каналы АЦП AD1IN19/AD2IN3, площадка U16

#### IB-FB, выход DRV8301
Коэффициент усиления программируется в DRV8301 (10, 20, 40 или 80 V/V).
Токоизмерительный резистор имеет номинал 0.002 Ом.
Итоговый коэффициент преобразования тока: 0.02, 0.04, 0.08 или 0.16 Вольт/Ампер.

Контакт 17 разъёма, через 33 Ома на каналы АЦП AD1IN21/AD2IN5, площадка T15

#### IC-FB = EXT\_IC-FB, выход TLV2781DBVR
Коэффициент усиления =20.
Токоизмерительный резистор имеет номинал 0.002 Ом.
Итоговый коэффициент преобразования тока: 0.04 Вольта/Ампер.

Контакт 67 разъёма, через 33 Ома на каналы АЦП AD1IN13/AD2IN13, площадка T18
Контакт 63 разъёма, через 33 Ома на каналы АЦП AD1IN11/AD2IN11, площадка U19

### Измерение напряжения
Производится через делитель 95.3 кОм -> 4.99 кОм плюс фильтрующий конденсатор 0.1 мкФ.
Итоговый коэффициент преобразования напряжения: U = Uadc * (1 + 95.3/4.99) = Uadc * 20.0982
Буферов нет, сигнал через резистор 33 Ома подаётся напрямую на АЦП.

#### ADC\_Vhb1, напряжение на обмотке A
Контакт 21 разъёма, через 33 Ома на каналы АЦП AD1IN23/AD2IN7, площадка R16

#### ADC\_Vhb2, напряжение на обмотке B
Контакт 71 разъёма, через 33 Ома на каналы АЦП AD1IN15/AD2IN15, площадка P19

#### ADC\_Vhb3, напряжение на обмотке C
Контакт 15 разъёма, через 33 Ома на каналы АЦП AD1IN20/AD2IN4, площадка U15

#### VDCBUS, напряжение питания
Контакт 11 разъёма, через 33 Ома на каналы АЦП AD1IN18/AD2IN2, площадка U14

### Подключение DRV8301 по SPI
Подключение выполняется через мультиплексор, который может к линиям SPI DRV8301 подключить разные площадки микроконтроллера, в зависимости от состояния контакта GIOB1, управляющего мультиплексором. В описаниях сигналов вначале указаны площадки при GIOB1=0, потом при GIOB1=1.

#### /SCS
Контакт 86 разъёма, цепь GPIO\_27.
NHET1\_30 или NHET1\_11.

#### SDI
Контакт 35 разъёма, цепь GPIO\_24. Вход в DRV8301.
NHET1\_15 или NHET1\_5.

#### SDO
Контакт 85 разъёма, цепь GPIO\_25. Выход из DRV8301.
NHET1\_31 или NHET1\_9.

#### SCLK
Контакт 36 разъёма, цепь GPIO\_26.
NHET1\_20 или NHET1\_7.


### Разъём J10 для подключения 3 логических входных сигналов (подразумеваются датчики на основе эффекта Холла)

#### J10.1, цепь E2A, цепь CAP1.
Контакт 30 разъёма. NHET1\_13.

#### J10.2, цепь E2B, цепь CAP2.
Контакт 80 разъёма. NHET1\_17.

#### J10.3, цепь E2C, цепь CAP3.
Контакт 31 разъёма. Цепь GIOB5. Не заведён на модуль HET.

#### J10.4, напряжение +5V

#### J10.5, земля


### Разъём J4 для подключения 3 логических входных сигналов (подразумевается энкодер)

#### J4.1, цепь E1A, цепь QEPA.
Контакт 40 разъёма. NHET1\_25.

#### J4.2, цепь E1B, цепь QEPB.
Контакт 90 разъёма. NHET1\_27.

#### J4.3, цепь E1C, цепь QEPI.
Контакт 91 разъёма. NHET1\_21.

#### J4.4, напряжение +5V

#### J4.5, земля

### Разъём J6 для отладочного ШИМ
* J6.1 = DAC\_PWM1 = HET1.23 = к.26 разъёма
* J6.2 = DAC\_PWM2 = HET1.29 = к.28 разъёма
* J6.3 = DAC\_PWM3 = HET1.22 = к.79 разъёма
* J6.4 = DAC\_PWM4 = HET1.16 = к.29 разъёма (при GIOB0=0) 

# Проблемы с DMA и SCI2
Для снижения числа выполняемых инструкций и отказа от прерывания по завершению передачи DMA я решил:
1) при инициализации модуля DMA (после завершения инициализации модуля SCI2) разрешить передатчику модуля SCI2 генерировать запросы в модуль DMA;
2) инициировать передачу DMA путём разрешения одного из каналов DMA; канал DMA автоматически выключится после передачи всех данных.

Однако, как оказалось, разрешение работы канала DMA не приводит к старту работы DMA.

Исследования показали следующее.
1. если изменился счётчик передаваемых данных (вне зависимости от того, разрешена или нет работа канала!!!) и был активный запрос к DMA, то после включения канала модуль DMA не обслуживает запросы на передачу; для выхода из ступора надо снять активный запрос к DMA и снова его сформировать. Я ожидал, что изменение счётчика передаваемых данных возможно без всяких проблем при выключенном канале DMA вне состояния от наличия активных запросов.
2. нормальная передача возможна, если изменение счётчика ITCOUNT производится при неактивном запросе к модулю DMA, вне зависимости от того, включен ли канал DMA или же выключен.

# Фазировка ДВМ70-ЭТ17ШТ
Отличается от Maxon EC-Max 30, Maxon 60 Flat, Teknic M-3210P-LN-04K в направлении вращения. Если ДВМ70-ЭТ17ШТ вращается по часовой стрелке со стороны ротора, то все остальные -- против часовой.
Я в разъёме MiniFit-4 поменял местами обмотку I и II, надо иметь в виду при формировании КД. Также следует корректно определить фазировку датчиков Холла (чтобы соответствовали импортным аналогам).

# Сводная информация по модулю HET1
## Вывод контактов на разъём DIMM100
* площадка K18, HET0, цепь NHET1\_00,                                    контакт 23, DRV8301.INH\_A
* площадка W5, HET2, цепь NHET1\_02,                                     контакт 73, DRV8301.INL\_A
* площадка B12, HET4, цепь NHET1\_04,                                    контакт 24, DRV8301.INH\_B
* площадка W3, HET6, цепь NHET1\_06,                                     контакт 74, DRV8301.INL\_B
* площадка N2, HET13, цепь NHET1\_13,                                    контакт 30, цепь CAP1
* площадка A13, HET17, цепь NHET1\_17,                                   контакт 80, цепь CAP2
* площадка H4, HET21/EMIF\_WAIT, цепь NHET1\_21,                         контакт 91, цепь QEPI
* площадка M3, HET25, цепь NHET1\_25,                                    контакт 40, цепь QEPA
* площадка A9, HET27, цепь NHET1\_27,                                    контакт 90, цепь QEPB
* площадка J4, HET23, цепь NHET1\_23,                                    контакт 29, цепь DAC\_PWM1
* площадка A3, HET29, цепь NHET1\_29,                                    контакт 79, цепь DAC\_PWM2
* площадка B3, HET22, цепь NHET1\_22,                                    контакт 28, цепь DAC\_PWM3
* площадка U1, HET3/NHET2[10], цепь NHET1\_03,                           контакт 41, цепь STATUS
* площадка A11, HET14, цепь NHET1\_14,                                   контакт 78, цепь START

### GIOB0=0 (используется в лабораторных работах)
* площадка E18, HET8, цепь NHET1\_08,                     цепь GPIO\_04, контакт 25, DRV8301.INH\_C
* площадка D19, HET10, цепь NHET1\_10,                    цепь GPIO\_05, контакт 75, DRV8301.INL\_C
* площадка A4, HET16, цепь NHET1\_16,                     цепь GPIO\_06, контакт 26, цепь DAC\_PWM4
* площадка J1, HET18, цепь NHET1\_18,                     цепь GPIO\_07, контакт 76, цепь STOP

### GIOB1=0 (используется в лабораторных работах)
* площадка N1, HET15, цепь NHET1\_15,                     цепь GPIO\_24, контакт 35, DRV8301.SDI
* площадка J17, HET31, цепь NHET1\_31,                    цепь GPIO\_25, контакт 85, DRV8301.SDO
* площадка P2, HET20, цепь NHET1\_20,                     цепь GPIO\_26, контакт 36, DRV8301.SCLK
* площадка B11, HET30, цепь NHET1\_30,                    цепь GPIO\_27, контакт 86, DRV8301.SCS

### GIOB1=1
* площадка V6, HET5/NHET2[12], цепь NHET1[5]/NHET2[12],   цепь GPIO\_24, контакт 35, DRV8301.SDI
* площадка V7, HET9/NHET2[16], цепь NHET1[9]/NHET2[16],   цепь GPIO\_25, контакт 85, DRV8301.SDO
* площадка T1, HET7/NHET2[14], цепь NHET1[7]/NHET2[14],   цепь GPIO\_26, контакт 36, DRV8301.SCLK
* площадка E3, HET11/NHET2[18], цепь NHET1[11]/NHET2[18], цепь GPIO\_27, контакт 86, DRV8301.SCS

## Вывод прочих контактов
* площадка V2, HET1/NHET2[8], цепь NHET1\_01, светодиод D15 на процессорном модуле
* площадка B4, HET12, цепь RMII\_CRS\_DV, идёт на PHY
* площадка P1, HET24, цепь RMII\_RXD[0]
* площадка A14, HET26, цепь RMII\_RXD[1]
* площадка K19, HET28, цепь RMII\_REFCLK
* площадка B13, HET19, не используется
